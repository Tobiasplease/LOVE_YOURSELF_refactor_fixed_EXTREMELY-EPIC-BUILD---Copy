import os

target = os.path.join("captioner", "captioner.py")

with open(target, "r", encoding="utf-8") as f:
    lines = f.readlines()

new_lines = []
inside_function = False
skip_block = False

for i, line in enumerate(lines):
    if "def _process_frame" in line:
        inside_function = True

    if inside_function and "note = generate_internal_note" in line:
        skip_block = True

    if skip_block:
        if "print(note)" in line:
            skip_block = False
        continue

    if inside_function and "print(f\"[{time.strftime('%H:%M:%S')}" in line:
        new_lines.append('    print("...")\n')
        new_lines.append(line)
        continue

    new_lines.append(line)

# Re-insert cleaned generate_internal_note call
insert_index = next(i for i, l in enumerate(new_lines) if "saw_person =" in l) + 1
note_block = """    generate_internal_note(
        caption,
        self.last_caption,
        self.current_mood,
        self.last_mood,
        saw_person,
        self.last_person_detected,
    )
"""

new_lines.insert(insert_index, note_block)

with open(target, "w", encoding="utf-8") as f:
    f.writelines(new_lines)

print("âœ… Cleaned up duplicate caption prints.")
